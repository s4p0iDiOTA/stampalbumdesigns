# üöÄ Production Deployment Checklist

This checklist guides you through deploying Stamp Album Designs to production.

## ‚ö†Ô∏è Pre-Deployment Requirements

### 1. Environment Setup

- [ ] Production server meets requirements:
  - [ ] PHP 8.2 or higher
  - [ ] Composer installed
  - [ ] Node.js & NPM installed
  - [ ] MySQL or PostgreSQL database (SQLite not recommended for production)
  - [ ] SSL certificate configured
  - [ ] Domain configured and pointing to server

### 2. Code Preparation

- [ ] All code committed to git
- [ ] All tests passing locally (`php artisan test`)
- [ ] No debug code or `dd()` statements
- [ ] Remove any test/development routes
- [ ] Code formatted with Pint (`vendor/bin/pint`)

---

## üì¶ Step 1: Server Setup

### 1.1 Clone Repository

```bash
cd /var/www
git clone <your-repository-url> stampalbumdesigns
cd stampalbumdesigns
```

### 1.2 Install Dependencies

```bash
# Install PHP dependencies
composer install --optimize-autoloader --no-dev

# Install NPM dependencies
npm install

# Build frontend assets for production
npm run build
```

### 1.3 Set Permissions

```bash
# Set correct ownership
chown -R www-data:www-data /var/www/stampalbumdesigns

# Set permissions
chmod -R 755 /var/www/stampalbumdesigns
chmod -R 775 /var/www/stampalbumdesigns/storage
chmod -R 775 /var/www/stampalbumdesigns/bootstrap/cache
```

---

## üîê Step 2: Environment Configuration

### 2.1 Create Production .env

```bash
cp .env.example .env
php artisan key:generate
```

### 2.2 Configure .env File

Edit `.env` with production values:

```env
APP_NAME="Stamp Album Designs"
APP_ENV=production
APP_KEY=base64:... # Generated by key:generate
APP_DEBUG=false  # ‚ö†Ô∏è MUST be false in production
APP_URL=https://yourdomain.com

# Database (use MySQL or PostgreSQL)
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=stampalbumdesigns_production
DB_USERNAME=production_user
DB_PASSWORD=your_secure_password

# Cache & Session (use Redis in production)
CACHE_DRIVER=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis

REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

# Mail (configure your mail service)
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=587
MAIL_USERNAME=your_username
MAIL_PASSWORD=your_password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@yourdomain.com
MAIL_FROM_NAME="${APP_NAME}"

# Lunar Settings
LUNAR_PANEL_PATH=admin  # Change from /lunar to /admin for security

# Optional: Stripe (for Phase 2)
# STRIPE_KEY=pk_live_...
# STRIPE_SECRET=sk_live_...
# STRIPE_WEBHOOK_SECRET=whsec_...
```

---

## üóÑÔ∏è Step 3: Database Setup

### 3.1 Create Production Database

```bash
# Login to MySQL
mysql -u root -p

# Create database and user
CREATE DATABASE stampalbumdesigns_production CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'production_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON stampalbumdesigns_production.* TO 'production_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 3.2 Run Migrations

```bash
# Run migrations (creates all tables including Lunar)
php artisan migrate --force

# ‚ö†Ô∏è Important: This creates the following:
# - User tables
# - Role and permission tables
# - 60+ Lunar tables (orders, products, etc.)
# - Core data (Currency, Channel, Language, CustomerGroup, Country)
```

### 3.3 Verify Migration Success

```bash
# Check that tables were created
php artisan tinker --execute="
echo 'Checking database setup...' . PHP_EOL;
echo 'Users table: ' . (\Schema::hasTable('users') ? '‚úÖ' : '‚ùå') . PHP_EOL;
echo 'Lunar orders table: ' . (\Schema::hasTable('lunar_orders') ? '‚úÖ' : '‚ùå') . PHP_EOL;
echo 'Roles table: ' . (\Schema::hasTable('roles') ? '‚úÖ' : '‚ùå') . PHP_EOL;
echo 'Currency count: ' . \Lunar\Models\Currency::count() . PHP_EOL;
echo 'Channel count: ' . \Lunar\Models\Channel::count() . PHP_EOL;
"
```

---

## üë§ Step 4: Create Production Admin User

**‚ö†Ô∏è DO NOT use test credentials in production!**

```bash
# Create production admin user
php artisan user:create-admin

# You will be prompted for:
# - Admin name
# - Admin email (use your real email)
# - Admin password (use a strong password)
```

**Important Notes:**
- Use a **strong, unique password** (at least 16 characters)
- Use a **real email address** you have access to
- Save credentials in a secure password manager
- **Never commit** production credentials to git

---

## üîí Step 5: Security Hardening

### 5.1 Optimize Laravel

```bash
# Clear all caches
php artisan optimize:clear

# Optimize for production
php artisan config:cache
php artisan route:cache
php artisan view:cache
php artisan event:cache

# Generate optimized autoloader
composer dump-autoload --optimize
```

### 5.2 Security Checklist

- [ ] `APP_DEBUG=false` in `.env`
- [ ] `APP_ENV=production` in `.env`
- [ ] Strong `APP_KEY` generated
- [ ] Database credentials are secure
- [ ] `.env` file has correct permissions (600)
- [ ] Storage and cache directories writable by web server
- [ ] All sensitive files in `.gitignore`

### 5.3 Configure Web Server

**For Nginx:**

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name yourdomain.com;
    root /var/www/stampalbumdesigns/public;

    ssl_certificate /path/to/ssl/cert.pem;
    ssl_certificate_key /path/to/ssl/key.pem;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

**For Apache:**

```apache
<VirtualHost *:80>
    ServerName yourdomain.com
    Redirect permanent / https://yourdomain.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName yourdomain.com
    DocumentRoot /var/www/stampalbumdesigns/public

    SSLEngine on
    SSLCertificateFile /path/to/ssl/cert.pem
    SSLCertificateKeyFile /path/to/ssl/key.pem

    <Directory /var/www/stampalbumdesigns/public>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/stampalbumdesigns-error.log
    CustomLog ${APACHE_LOG_DIR}/stampalbumdesigns-access.log combined
</VirtualHost>
```

---

## üß™ Step 6: Production Testing

### 6.1 Run Tests on Production Server

```bash
# Run test suite on production server
php artisan test

# Expected: 46 tests passing (188 assertions)
```

### 6.2 Manual Testing Checklist

**Public Pages:**
- [ ] Visit homepage (`/`)
- [ ] Visit `/order` - verify order builder loads
- [ ] Test country search
- [ ] Test year range selection
- [ ] Add items to cart
- [ ] Visit `/cart` - verify cart displays

**Authentication:**
- [ ] Register new user at `/register`
- [ ] Login at `/login`
- [ ] Logout at `/logout`
- [ ] Password reset flow

**Customer Portal:**
- [ ] Login as customer
- [ ] Visit `/my-orders` (should be empty initially)
- [ ] Create a test order
- [ ] Verify order appears in `/my-orders`
- [ ] Click order to view details
- [ ] Verify all JSON data displays correctly

**Admin Portal:**
- [ ] Login as admin
- [ ] Visit `/dashboard`
- [ ] Visit `/lunar` (or `/admin` if you changed LUNAR_PANEL_PATH)
- [ ] Navigate to Orders
- [ ] View order details
- [ ] Check user management at `/lunar/users`
- [ ] Verify admin can see all orders

**Security Testing:**
- [ ] Try accessing `/dashboard` as non-admin ‚Üí 403 Forbidden
- [ ] Try accessing `/lunar` as customer ‚Üí 403 Forbidden
- [ ] Verify customer can only see their own orders
- [ ] Test CSRF protection on forms

---

## üìä Step 7: Monitoring Setup

### 7.1 Configure Error Logging

```bash
# Ensure logs directory exists
mkdir -p storage/logs
chmod 775 storage/logs
```

### 7.2 Set Up Log Rotation

Create `/etc/logrotate.d/stampalbumdesigns`:

```
/var/www/stampalbumdesigns/storage/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    notifempty
    sharedscripts
    postrotate
        /usr/sbin/service php8.2-fpm reload > /dev/null
    endscript
}
```

### 7.3 Monitor Application

```bash
# Check Laravel logs
tail -f storage/logs/laravel.log

# Monitor PHP-FPM
tail -f /var/log/php8.2-fpm.log

# Monitor web server
tail -f /var/log/nginx/error.log
```

---

## üîÑ Step 8: Backup Strategy

### 8.1 Database Backups

Create backup script `/usr/local/bin/backup-stampalbum.sh`:

```bash
#!/bin/bash
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_DIR="/backups/stampalbumdesigns"
DB_NAME="stampalbumdesigns_production"
DB_USER="production_user"
DB_PASS="your_secure_password"

mkdir -p $BACKUP_DIR

# Backup database
mysqldump -u $DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_DIR/db_$TIMESTAMP.sql.gz

# Backup uploaded files (if any in future)
tar -czf $BACKUP_DIR/storage_$TIMESTAMP.tar.gz /var/www/stampalbumdesigns/storage/app

# Keep only last 30 days
find $BACKUP_DIR -name "*.gz" -mtime +30 -delete

echo "Backup completed: $TIMESTAMP"
```

```bash
# Make executable
chmod +x /usr/local/bin/backup-stampalbum.sh

# Add to crontab (daily at 2 AM)
crontab -e
# Add: 0 2 * * * /usr/local/bin/backup-stampalbum.sh
```

### 8.2 Code Backups

```bash
# Ensure git repository is up to date
cd /var/www/stampalbumdesigns
git remote -v  # Verify remote is set
```

---

## üìã Step 9: Maintenance Mode

### 9.1 Enable Maintenance Mode (for updates)

```bash
# Enable maintenance mode
php artisan down --message="We'll be back soon! Performing scheduled maintenance."

# Perform updates...

# Disable maintenance mode
php artisan up
```

### 9.2 Allow Admin Access During Maintenance

```bash
# Enable maintenance mode but allow admin IP
php artisan down --secret="your-secret-token"

# Admin can access via: https://yourdomain.com/your-secret-token
```

---

## üöÄ Step 10: Go Live!

### 10.1 Final Checks

- [ ] All tests passing
- [ ] Admin user created and can login
- [ ] SSL certificate valid
- [ ] DNS pointing to server
- [ ] Backups configured
- [ ] Error monitoring set up
- [ ] `.env` file secured

### 10.2 Post-Launch Monitoring

**First 24 Hours:**
- [ ] Monitor error logs every 2 hours
- [ ] Check order creation flow
- [ ] Verify emails are sending (when configured)
- [ ] Monitor server resources (CPU, memory, disk)
- [ ] Check database connection pool

**First Week:**
- [ ] Daily log review
- [ ] Monitor order volume
- [ ] Check for any 500 errors
- [ ] Verify backups are running
- [ ] Test order notifications

---

## üîÑ Future Updates

### Deploying Updates

```bash
# Put site in maintenance mode
php artisan down

# Pull latest code
git pull origin main

# Update dependencies
composer install --optimize-autoloader --no-dev
npm install && npm run build

# Run migrations (if any)
php artisan migrate --force

# Clear and rebuild caches
php artisan optimize:clear
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Bring site back online
php artisan up
```

---

## üìû Support Contacts

**Emergency Contacts:**
- Server Admin: _____________
- Database Admin: _____________
- Development Team: _____________

**Important URLs:**
- Production Site: https://yourdomain.com
- Admin Panel: https://yourdomain.com/lunar
- Server SSH: ssh user@server-ip

---

## ‚úÖ Production Deployment Completion

Once all steps are complete:

- [ ] Site accessible at production URL
- [ ] Admin can login and manage orders
- [ ] Customers can register and place orders
- [ ] Order data captured correctly from JSON files
- [ ] All 46 tests passing on production
- [ ] Backups running daily
- [ ] Monitoring configured
- [ ] SSL certificate active
- [ ] Production `.env` secured

**Deployment Date:** _______________
**Deployed By:** _______________
**Version:** 2.0.0 (Lunar Phase 1)

---

## üéØ Phase 2 Preparation

After successful deployment, prepare for Phase 2:

- [ ] Set up Stripe account (live keys)
- [ ] Configure email service (SendGrid, Mailgun, etc.)
- [ ] Plan PDF invoice template
- [ ] Set up automated email notifications
- [ ] Consider CDN for static assets
- [ ] Plan for product catalog expansion

**Next Milestone:** Stripe Payment Integration
